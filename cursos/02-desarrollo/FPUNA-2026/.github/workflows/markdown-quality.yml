name: Markdown Quality Check

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.md'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.md'
  schedule:
    # Run monthly on the 1st at midnight
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  markdown-lint:
    name: Lint Markdown Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Lint markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          config: '.markdownlint.json'
          args: '**/*.md'
          ignore: 'node_modules'

  link-check:
    name: Check External Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check external links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: '.'
          file-extension: '.md'

  spellcheck:
    name: Spell Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Spell check markdown files
        uses: rojopolis/spellcheck-github-actions@0.29.0
        with:
          config_path: '.github/spellcheck-config.yml'
          task_name: Markdown

  code-blocks:
    name: Validate Code Blocks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install markdown-code-runner
        run: npm install -g markdown-code-runner
      
      - name: Extract and validate TypeScript code blocks
        run: |
          echo "Extracting TypeScript code blocks..."
          find . -name "*.md" -type f -exec grep -l "```typescript" {} \; | while read file; do
            echo "Checking $file..."
          done
        continue-on-error: true

  structure-check:
    name: Check File Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Verify track structure
        run: |
          echo "Checking track structure..."
          
          # Check all tracks have README.md
          for track in 01-SOFTWARE-DEVELOPMENT 02-ELECTRONICS-AUTOMATION 03-AERONAUTICAL-ENGINEERING 04-MARKETING-COMMUNICATION 05-RESEARCH-ACADEMIA 06-HOSPITALITY-TOURISM 07-QA-AUTOMATION 08-WEB-DEVELOPMENT; do
            if [ ! -f "$track/README.md" ]; then
              echo "❌ Missing $track/README.md"
              exit 1
            else
              echo "✅ $track/README.md exists"
            fi
          done
          
          # Check SHARED components
          if [ ! -d "SHARED/components" ]; then
            echo "❌ Missing SHARED/components directory"
            exit 1
          else
            echo "✅ SHARED/components exists"
          fi
          
          echo "✅ All structure checks passed!"

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-check, structure-check]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "## Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Lint | ${{ needs.markdown-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Link Check | ${{ needs.link-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Check | ${{ needs.structure-check.result }} |" >> $GITHUB_STEP_SUMMARY
