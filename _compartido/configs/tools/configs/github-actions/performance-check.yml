name: Performance Check

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/login
            http://localhost:3000/dashboard
          budgetPath: ./lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            // Read Lighthouse results
            const resultsPath = '.lighthouseci';
            if (!fs.existsSync(resultsPath)) {
              console.log('No Lighthouse results found');
              return;
            }

            const files = fs.readdirSync(resultsPath).filter(f => f.endsWith('.json'));
            const results = files.map(f => {
              const data = JSON.parse(fs.readFileSync(`${resultsPath}/${f}`, 'utf8'));
              return {
                url: data.finalUrl,
                performance: Math.round(data.categories.performance.score * 100),
                accessibility: Math.round(data.categories.accessibility.score * 100),
                bestPractices: Math.round(data.categories['best-practices'].score * 100),
                seo: Math.round(data.categories.seo.score * 100),
              };
            });

            const body = `## Lighthouse Performance Report

            | URL | Performance | Accessibility | Best Practices | SEO |
            |-----|-------------|---------------|----------------|-----|
            ${results.map(r =>
              `| ${r.url} | ${r.performance} | ${r.accessibility} | ${r.bestPractices} | ${r.seo} |`
            ).join('\n')}

            ### Thresholds
            - Performance: 90+
            - Accessibility: 100
            - Best Practices: 90+
            - SEO: 90+

            ---
            *View full report in artifacts*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz | tar xvz
          sudo mv k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

      - name: Run load test
        run: k6 run tests/load/load-test.js --out json=load-results.json
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-results.json
