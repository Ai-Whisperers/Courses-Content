# ‚ö° CI/CD Local - Sistema de Hooks Enterprise-Grade
# Basado en mejores pr√°cticas de Google, Meta, Netflix, Microsoft (2025)
# Framework: pre-commit v4.0+

# ============================================
# üîÑ CONFIGURACI√ìN GENERAL
# ============================================

# Default stages (runs on all stages by default)
default_stages: [pre-commit, pre-push, manual]

# Fail fast - stop on first failure (set to true for stricter CI)
fail_fast: false

# Number of parallel jobs (auto = detect CPU cores)
# High-performance repos use parallel execution
parallel_jobs: auto

# Global exclude patterns (these files are never checked)
exclude: >
  (?x)^(
    .*\.min\.(js|css)$|
    .*\.map$|
    node_modules/|
    venv/|
    \.venv/|
    __pycache__/|
    \.git/|
    \.tox/|
    \.pytest_cache/|
    \.mypy_cache/|
    \.coverage|
    htmlcov/|
    dist/|
    build/|
    \.egg-info/|
    migrations/|
    \.claude/settings\.local\.json|
    .*\.lock$
  )$

# ============================================
# üîí SEGURIDAD - PRIMERA L√çNEA DE DEFENSA
# ============================================
# Prioridad: CR√çTICA - Nunca se salta

repos:
  # 1. DETECT-SECRETS - Detecta secrets antes del commit
  # Standard de la industria usado por Uber, Stripe, etc.
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: üîí Detect Secrets
        description: Detect secrets in codebase before commit
        entry: detect-secrets-hook
        language: python
        stages: [pre-commit]
        args: ['--baseline', '.secrets.baseline']
        always_run: true
        # Critical - cannot be skipped
        verbose: true

  # 2. GITGUARDIAN - Escaneo de secrets avanzado (si tienes API key)
  # Alternativa: usar gitleaks (open source)
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks:
      - id: gitleaks
        name: üîç Gitleaks - Secret Scanner
        description: Detect hardcoded secrets using Gitleaks
        entry: gitleaks detect --source . --verbose --redact
        language: golang
        pass_filenames: false
        stages: [pre-commit]
        always_run: true

  # 3. BANDIT - Security linting para Python
  # Detecta vulnerabilidades de seguridad en c√≥digo Python
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.7
    hooks:
      - id: bandit
        name: üõ°Ô∏è Bandit - Security Linter
        description: Find common security issues in Python code
        entry: bandit
        language: python
        types: [python]
        args: 
          - -c
          - pyproject.toml
          - -lll
          - -ii
          - --exclude
          - tests/
        # Skip tests as they often need "dangerous" patterns for mocking
        exclude: ^tests/.*$

  # 4. PIP-AUDIT - Auditor√≠a de dependencias vulnerable
  # Revisa vulnerabilidades en requirements.txt / pyproject.toml
  - repo: https://github.com/pypa/pip-audit
    rev: v2.7.2
    hooks:
      - id: pip-audit
        name: üì¶ Pip-Audit - Dependency Check
        description: Scan for known vulnerabilities in dependencies
        entry: pip-audit
        language: python
        pass_filenames: false
        always_run: true
        args:
          - --desc
          - --skip=dev
          - -r
          - requirements.txt
        # Only runs if requirements.txt exists
        files: ^(requirements.*\.txt|pyproject\.toml)$

  # 5. CHECK FOR PRIVATE KEYS - Validaci√≥n manual de claves
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: detect-private-key
        name: üîê Detect Private Keys
        description: Detects the presence of private keys
        stages: [pre-commit]

# ============================================
# üé® CALIDAD DE C√ìDIGO - FORMATEO Y ESTILO
# ============================================
# Prioridad: ALTA - Asegura consistencia

  # 6. TRAILING WHITESPACE - Limpieza b√°sica
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: ‚úÇÔ∏è Trim Trailing Whitespace
        description: Remove trailing whitespace
        stages: [pre-commit]

      - id: end-of-file-fixer
        name: üìÑ Fix End of Files
        description: Ensure files end with a newline
        stages: [pre-commit]

      - id: check-merge-conflict
        name: ‚öîÔ∏è  Check Merge Conflicts
        description: Check for files that contain merge conflict strings
        stages: [pre-commit]

      - id: check-added-large-files
        name: üêò Check Large Files
        description: Prevent giant files from being committed
        args: ['--maxkb=500']
        stages: [pre-commit]

      - id: check-json
        name: üìã Validate JSON
        description: Validate JSON files
        stages: [pre-commit]

      - id: check-yaml
        name: üìã Validate YAML
        description: Validate YAML files
        stages: [pre-commit]

      - id: check-toml
        name: üìã Validate TOML
        description: Validate TOML files
        stages: [pre-commit]

      - id: mixed-line-ending
        name: üîÑ Fix Line Endings
        description: Replace mixed line endings with LF
        args: ['--fix=lf']
        stages: [pre-commit]

  # 7. BLACK - Formateador de c√≥digo Python (standard de facto)
  - repo: https://github.com/psf/black
    rev: 24.2.0
    hooks:
      - id: black
        name: üñ§ Black - Code Formatter
        description: Format Python code with Black
        language: python
        types: [python]
        args:
          - --line-length=120
          - --target-version=py311
          - --safe
          - --quiet
        # Exclude tests if they have special formatting needs
        exclude: ^migrations/|^tests/fixtures/

  # 8. BLACK-JUPYTER - Formateo para notebooks
  - repo: https://github.com/psf/black
    rev: 24.2.0
    hooks:
      - id: black-jupyter
        name: üìì Black Jupyter - Notebook Formatter
        description: Format Jupyter notebooks with Black
        types: [jupyter]
        args:
          - --line-length=120

  # 9. ISORT - Ordenamiento de imports
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: üìö isort - Import Sorting
        description: Sort and organize Python imports
        types: [python]
        args:
          - --profile=black
          - --line-length=120
          - --multi-line=3
          - --force-grid-wrap=0
          - --use-parentheses
          - --ensure-newline-before-comments

  # 10. RUFF - Linter ultra-r√°pido (Rust-based, reemplaza flake8)
  # Usado por pandas, FastAPI, etc.
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.2.2
    hooks:
      - id: ruff
        name: ‚ö° Ruff - Fast Python Linter
        description: Run Ruff fast Python linter
        types: [python]
        args:
          - --fix
          - --exit-non-zero-on-fix
          - --show-source
          - --show-fixes
        # Use ruff instead of flake8 for speed (optional)
        # Keep both for comprehensive checking

  # 11. FLAKE8 - Linter tradicional (complemento a ruff)
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: üîç Flake8 - Style Guide Enforcement
        description: Enforce style guide with Flake8
        types: [python]
        args:
          - --max-line-length=120
          - --extend-ignore=E203,W503,F403,F405,F821,E501,E722
          - --max-complexity=12
          - --max-doc-length=120
          - --statistics
          - --count
        additional_dependencies:
          - flake8-bugbear
          - flake8-comprehensions
          - flake8-docstrings
          - flake8-import-order
          - flake8-simplify

  # 12. MYPY - Type checking est√°tico
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: üè∑Ô∏è  Mypy - Static Type Checking
        description: Run mypy static type checker
        types: [python]
        args:
          - --ignore-missing-imports
          - --warn-redundant-casts
          - --warn-unused-ignores
          - --warn-return-any
          - --warn-unreachable
          - --strict
          - --show-error-codes
          - --show-column-numbers
          - --pretty
          - --python-version=3.11
        additional_dependencies:
          - pydantic
          - types-python-dateutil
          - types-requests
          - types-pyyaml
        # Can be slow on large repos - run selectively
        stages: [pre-push, manual]

# ============================================
# üß™ TESTING - VALIDACI√ìN DE CALIDAD
# ============================================
# Prioridad: ALTA - Asegura funcionalidad

  # 13. PYTEST - Tests con cobertura m√≠nima
  - repo: local
    hooks:
      - id: pytest-check
        name: üß™ Pytest - Unit Tests
        description: Run pytest unit tests
        entry: python -m pytest
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push, manual]
        args:
          - -v
          - --tb=short
          - --color=yes
          - --maxfail=5
          - -x
        # Skip if no tests or if tests are too slow
        # Move to CI for very large test suites

      - id: pytest-coverage
        name: üìä Pytest Coverage Check
        description: Verify minimum test coverage
        entry: python -m pytest
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push, manual]
        args:
          - --cov=src
          - --cov-report=term-missing
          - --cov-fail-under=70
          - --no-cov-on-fail
        # Requiere 70% de coverage m√≠nimo (ajustar seg√∫n proyecto)

  # 14. DOCTEST - Tests en docstrings
  - repo: local
    hooks:
      - id: doctest
        name: üìñ Doctest - Documentation Tests
        description: Run doctest on Python files
        entry: python -m doctest
        language: system
        types: [python]
        stages: [pre-push, manual]

# ============================================
# üìù COMMITS - VALIDACI√ìN DE MENSAJES
# ============================================
# Prioridad: MEDIA - Buenas pr√°cticas de Git

  # 15. COMMITIZEN - Conventional commits
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.13.0
    hooks:
      - id: commitizen
        name: üìù Commitizen - Commit Message Check
        description: Validate commit message follows conventional commits
        stages: [commit-msg]
        # Requiere que el mensaje siga: type(scope): subject

  # 16. GIT LINT - Validaci√≥n adicional de commits
  - repo: https://github.com/jorisroovers/gitlint
    rev: v0.19.1
    hooks:
      - id: gitlint
        name: üìè Gitlint - Commit Linter
        description: Lint commit messages
        stages: [commit-msg]
        args:
          - --ignore=B6
          - --contrib=contrib-title-conventional-commits

# ============================================
# üéØ VALIDACIONES ESPEC√çFICAS DEL PROYECTO
# ============================================
# Prioridad: MEDIA - Reglas del proyecto

  # 17. CHECK REPO ORGANIZATION - Estructura del proyecto
  - repo: local
    hooks:
      - id: check-repo-structure
        name: üèóÔ∏è  Check Repository Structure
        description: Validate repository organization rules
        entry: python scripts/hooks/check_repo_structure.py
        language: python
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

  # 18. CHECK CLAUDE CONFIG - Validaci√≥n de configuraci√≥n
  - repo: local
    hooks:
      - id: check-claude-config
        name: ü§ñ Check Claude Configuration
        description: Validate Claude Code configuration
        entry: python scripts/hooks/check_claude_config.py
        language: python
        pass_filenames: false
        always_run: false
        files: ^\.claude/.*$
        stages: [pre-commit]

  # 19. CHECK PYTHON PATH - PYTHONPATH v√°lido
  - repo: local
    hooks:
      - id: check-pythonpath
        name: üêç Check PYTHONPATH Configuration
        description: Verify PYTHONPATH is set correctly
        entry: python scripts/hooks/check_pythonpath.py
        language: python
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

  # 20. PROTECTED FILES - Protecci√≥n de archivos sensibles
  - repo: local
    hooks:
      - id: protected-files
        name: üîí Protected Files Check
        description: Prevent accidental modification of protected files
        entry: python scripts/hooks/check_protected_files.py
        language: python
        pass_filenames: true
        stages: [pre-commit]

# ============================================
# üöÄ OPTIMIZACI√ìN Y PERFORMANCE
# ============================================
# Prioridad: BAJA - Mejoras adicionales

  # 21. PYUPGRADE - Actualizaci√≥n autom√°tica de sintaxis
  - repo: https://github.com/asottile/pyupgrade
    rev: v3.15.1
    hooks:
      - id: pyupgrade
        name: ‚¨ÜÔ∏è  Pyupgrade - Python Upgrade
        description: Automatically upgrade Python syntax
        types: [python]
        args:
          - --py311-plus
          - --keep-runtime-typing

  # 22. AUTOSEMVER - Actualizaci√≥n autom√°tica de versi√≥n
  - repo: https://github.com/mtkennerly/pre-commit-hooks
    rev: v0.5.0
    hooks:
      - id: poetry-check
        name: üì¶ Poetry Check
        description: Validate pyproject.toml and poetry.lock
        files: ^(pyproject\.toml|poetry\.lock)$
        stages: [pre-commit]

# ============================================
# üîß CONFIGURACI√ìN DE REPOS LOCALES
# ============================================
# Hooks personalizados avanzados

  # 23. HOOK LOCAL AVANZADO - Performance Monitor
  - repo: local
    hooks:
      - id: performance-guardian
        name: ‚ö° Performance Guardian
        description: Check for performance anti-patterns
        entry: python scripts/hooks/performance_guardian.py
        language: python
        types: [python]
        stages: [pre-commit]

      - id: complexity-guardian
        name: üßÆ Complexity Guardian
        description: Check code complexity metrics
        entry: python scripts/hooks/complexity_guardian.py
        language: python
        types: [python]
        stages: [pre-push, manual]

      - id: import-guardian
        name: üì¶ Import Guardian
        description: Check for circular imports and unused imports
        entry: python scripts/hooks/import_guardian.py
        language: python
        types: [python]
        stages: [pre-commit]

# ============================================
# üéì EDUCACI√ìN Y ONBOARDING
# ============================================

  # 24. WELCOME MESSAGE - Para nuevos contribuidores
  - repo: local
    hooks:
      - id: welcome-contributor
        name: üëã Welcome Contributor
        description: Show helpful information for new contributors
        entry: python scripts/hooks/welcome_contributor.py
        language: python
        pass_filenames: false
        always_run: false
        verbose: true
        stages: [post-checkout]

# ============================================
# ‚öôÔ∏è  CONFIGURACI√ìN DE EJECUCI√ìN
# ============================================

# Variables de entorno para hooks
# Estas variables est√°n disponibles para todos los hooks

default_environment:
  # Forzar UTF-8 para consistencia cross-platform
  PYTHONIOENCODING: utf-8
  # Colores en output
  FORCE_COLOR: "1"
  # Deshabilitar pip cache para CI/CD (opcional)
  PIP_NO_CACHE_DIR: "1"
  # Python warnings
  PYTHONWARNINGS: "ignore:Unverified HTTPS request"

# ============================================
# üìã NOTAS Y RECURSOS
# ============================================

# INSTALACI√ìN:
#   pip install pre-commit
#   pre-commit install
#   pre-commit install --hook-type commit-msg
#
# USO:
#   pre-commit run --all-files          # Ejecutar todo
#   pre-commit run black                # Ejecutar solo black
#   pre-commit run --stage pre-push     # Solo pre-push hooks
#   SKIP=pytest git commit -m "..."     # Saltar pytest
#
# ACTUALIZACI√ìN:
#   pre-commit autoupdate               # Actualizar repos
#
# DEBUG:
#   pre-commit run --verbose            # Modo verbose
#   pre-commit run --show-diff-on-failure
#
# PARA BYPASS (no recomendado):
#   git commit --no-verify              # Saltar todos los hooks
#   SKIP=all git commit -m "..."
#
# DOCUMENTACI√ìN:
#   https://pre-commit.com/
#   https://github.com/pre-commit/pre-commit-hooks
