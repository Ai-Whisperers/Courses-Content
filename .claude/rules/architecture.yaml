# =============================================================================
# üèõÔ∏è ARCHITECTURE RULES - SISTEMA DE REGLAS DE ARQUITECTURA
# Basado en: Google Architecture, Microsoft Well-Architected, Airbnb Patterns
# Proyecto: FPUNA AI Education - Lead Architect Configuration
# =============================================================================

meta:
  version: "1.0.0"
  last_updated: "2025-01-30"
  maintainer: "FPUNA AI Education Team"
  scope: ["architecture", "design-patterns", "system-structure"]
  
  sources:
    - "Google Software Engineering Practices"
    - "Microsoft Azure Well-Architected Framework"
    - "Airbnb Engineering Principles"
    - "Kubernetes Architecture Patterns"
    - "12-Factor App Methodology"
    - "Clean Architecture - Robert C. Martin"
    - "Domain-Driven Design - Eric Evans"

# =============================================================================
# üéØ PRINCIPIOS FUNDAMENTALES DE ARQUITECTURA
# =============================================================================

principles:
  # Google: Simplicity is key
  simplicity:
    priority: "CRITICAL"
    description: "La arquitectura m√°s simple que resuelva el problema es la mejor"
    rules:
      - "Evitar over-engineering y premature optimization"
      - "Cada componente debe tener una responsabilidad clara y √∫nica"
      - "Preferir soluciones est√°ndar sobre custom"
      - "Si requiere m√°s de 5 minutos para explicar, es muy complejo"
    metrics:
      max_components_per_service: 7
      max_hierarchy_depth: 3
      max_module_dependencies: 10
  
  # Microsoft: Resiliency and reliability  
  resilience:
    priority: "CRITICAL"
    description: "El sistema debe tolerar fallos y recuperarse autom√°ticamente"
    rules:
      - "Todos los servicios externos deben tener circuit breakers"
      - "Implementar retries con exponential backoff"
      - "Dise√±ar para graceful degradation"
      - "Nunca asumir disponibilidad 100% de dependencias"
    patterns:
      required:
        - "Circuit Breaker"
        - "Retry with Backoff"
        - "Timeout on all external calls"
        - "Health Checks"
  
  # Airbnb: Scalability by design
  scalability:
    priority: "HIGH"
    description: "La arquitectura debe escalar horizontalmente"
    rules:
      - "Stateless services donde sea posible"
      - "Separar lecturas y escrituras cuando aplique (CQRS)"
      - "Dise√±ar para sharding desde el inicio"
      - "Usar colas para operaciones async"
    constraints:
      max_single_node_memory: "2GB"
      max_response_time_ms: 500
      target_throughput_rps: 1000
  
  # All: Security by design
  security_by_design:
    priority: "CRITICAL"
    description: "Seguridad en cada capa, no como afterthought"
    rules:
      - "Zero Trust - verificar todo, incluso internal"
      - "Principle of Least Privilege"
      - "Defense in depth - m√∫ltiples capas de seguridad"
      - "Never trust user input"
      - "Secrets nunca en c√≥digo, siempre en vault/servicio"

# =============================================================================
# üìê PATRONES DE ARQUITECTURA PERMITIDOS
# =============================================================================

patterns:
  # Microservices (para servicios independientes)
  microservices:
    when_to_use:
      - "Servicio tiene ciclo de vida independiente"
      - "Equipo de 6+ developers"
      - "Requiere deploy independiente"
      - "Diferentes patrones de carga"
    constraints:
      max_service_size_lines: 5000
      max_service_endpoints: 20
      max_database_per_service: 1
      max_sync_dependencies: 3
      communication: "async preferred, sync when latency < 100ms required"
    forbidden:
      - "Shared databases between services"
      - "Distributed transactions (use Saga pattern)"
      - "Synchronous chains > 3 services"
  
  # Monolith Modular (para proyectos FPUNA/educaci√≥n)
  modular_monolith:
    when_to_use:
      - "Proyecto educativo FPUNA"
      - "Equipo < 6 developers"
      - "Startup/MVP phase"
      - "Baja complejidad de dominio"
    structure:
      - "modules/ - M√≥dulos de dominio independientes"
      - "shared/ - Componentes compartidos"
      - "interfaces/ - API/UI adapters"
    constraints:
      max_module_size_lines: 3000
      max_module_dependencies: 5
      database: "single, schema-separated by module"
    
  # Clean Architecture / Ports & Adapters
  clean_architecture:
    layers:
      domain:
        contains: ["Entities", "Value Objects", "Domain Services", "Domain Events"]
        dependencies: "none - innermost layer"
        testing: "100% unit tests, no mocks needed"
      application:
        contains: ["Use Cases", "DTOs", "Application Services"]
        dependencies: ["domain"]
        testing: "unit tests with mocked domain"
      infrastructure:
        contains: ["DB", "External APIs", "Frameworks"]
        dependencies: ["application", "domain"]
        testing: "integration tests"
      interface:
        contains: ["Controllers", "Presenters", "Views"]
        dependencies: ["application"]
        testing: "e2e tests"
    rules:
      - "Las dependencias apuntan siempre hacia el dominio"
      - "El dominio nunca depende de frameworks"
      - "Interfaces se adaptan al dominio, no al rev√©s"
  
  # Event-Driven (para procesamiento async)
  event_driven:
    when_to_use:
      - "Procesos de larga duraci√≥n"
      - "Integraci√≥n con m√∫ltiples sistemas"
      - "Auditor√≠a completa requerida"
      - "Event sourcing necesario"
    event_structure:
      required_fields:
        - "event_id (UUID)"
        - "event_type (string: DomainName.Action)"
        - "aggregate_id (string)"
        - "timestamp (ISO8601)"
        - "version (integer)"
        - "payload (JSON)"
        - "metadata (correlation_id, causation_id)"
    constraints:
      max_event_size_kb: 64
      event_retention_days: 365
      max_processing_latency_ms: 5000

# =============================================================================
# üèóÔ∏è ESTRUCTURA DE PROYECTO (FILE ORGANIZATION)
# =============================================================================

project_structure:
  # Estructura base obligatoria para proyectos Python FPUNA
  base_structure:
    root_files:
      required:
        - "README.md": "Documentaci√≥n principal con badges, instalaci√≥n, uso"
        - "LICENSE": "MIT o compatible con educaci√≥n"
        - ".gitignore": "Python standard + personalizado"
        - "pyproject.toml": "Configuraci√≥n moderna Python"
      recommended:
        - "CONTRIBUTING.md": "Gu√≠a de contribuci√≥n"
        - "CODE_OF_CONDUCT.md": "Est√°ndares de comportamiento"
        - "SECURITY.md": "Pol√≠tica de seguridad"
        - "CHANGELOG.md": "Historial de cambios"
        - ".pre-commit-config.yaml": "Hooks de calidad"
        - "Makefile": "Comandos comunes"
    
    directories:
      src:
        description: "C√≥digo fuente principal"
        structure:
          "{package_name}/":
            - "__init__.py"
            - "domain/": "Entidades y l√≥gica de negocio"
            - "application/": "Casos de uso"
            - "infrastructure/": "Adaptadores t√©cnicos"
            - "interfaces/": "API/UI"
          
      tests:
        description: "Tests organizados por tipo"
        structure:
          "unit/": "Tests unitarios (r√°pidos, aislados)"
          "integration/": "Tests de integraci√≥n (DB, APIs)"
          "e2e/": "End-to-end tests (flujos completos)"
          "fixtures/": "Datos de prueba"
        
      docs:
        description: "Documentaci√≥n adicional"
        required:
          - "architecture/": "Diagrams y ADRs"
          - "api/": "Documentaci√≥n de API"
          - "guides/": "Gu√≠as de usuario"
      
      scripts:
        description: "Scripts de utilidad"
        allowed:
          - "hooks/": "Git hooks personalizados"
          - "setup/": "Scripts de setup"
          - "deploy/": "Scripts de deployment"
  
  # Reglas de nomenclatura de archivos
  naming_conventions:
    python_files:
      style: "snake_case"
      examples: ["user_service.py", "test_payment_gateway.py"]
      forbidden: ["camelCase.py", "UserService.py", "test.py"]
    
    test_files:
      pattern: "test_*.py o *_test.py"
      location: "Mirror structure under tests/"
      example: "src/auth/service.py ‚Üí tests/auth/test_service.py"
    
    directories:
      style: "snake_case"
      max_depth: 4
      forbidden: ["util", "utils", "helpers", "misc"]
  
  # L√≠mites de tama√±o
  size_limits:
    file_max_lines: 500
    file_max_chars: 20000
    function_max_lines: 50
    class_max_lines: 300
    module_max_lines: 1000
    
    # Excepciones permitidas
    exceptions:
      - "__init__.py (exports)"
      - "constants.py (configs)"
      - "generated/ (auto-generated)"

# =============================================================================
# üîÑ PATRONES DE DISE√ëO REQUERIDOS
# =============================================================================

required_patterns:
  # Dependency Injection
  dependency_injection:
    required: true
    description: "Todas las dependencias deben ser inyectadas, no hardcoded"
    implementation: ["Constructor injection preferred", "Framework DI optional"]
    forbidden: ["Service Locator", "Global state", "Singleton abuse"]
  
  # Repository Pattern
  repository:
    required_for: ["All database access"]
    description: "Abstract data access behind repository interfaces"
    rules:
      - "Dominio depende de Repository Interface"
      - "Infrastructure implementa Repository Interface"
      - "No SQL en capa de dominio"
    
  # Unit of Work
  unit_of_work:
    required_for: ["Multi-entity transactions"]
    description: "Mantener consistencia en operaciones complejas"
    
  # CQRS (when needed)
  cqrs:
    when_to_use: "Read/write ratio > 10:1 o diferentes modelos necesarios"
    implementation: "Separate command and query handlers"

# =============================================================================
# üóÑÔ∏è BASES DE DATOS Y ALMACENAMIENTO
# =============================================================================

data_storage:
  # PostgreSQL (default para datos relacionales)
  postgresql:
    use_for: ["Relational data", "ACID transactions", "Complex queries"]
    patterns:
      - "One database per service (microservices)"
      - "Schema separation per module (monolith)"
      - "Migration tool: Alembic"
      - "Connection pooling: min 5, max 20"
    forbidden:
      - "N+1 queries (usar eager loading)"
      - "SELECT * (especificar columnas)"
      - "Raw SQL en dominio"
  
  # Redis (cache y sesiones)
  redis:
    use_for: ["Caching", "Sessions", "Rate limiting", "Pub/sub"]
    patterns:
      - "TTL obligatorio en todas las keys"
      - "Key naming: service:entity:id:field"
      - "Max key size: 512MB (avoid large values)"
    
  # Qdrant (vectores - para IA)
  qdrant:
    use_for: ["Embeddings", "Semantic search", "RAG"]
    patterns:
      - "Collection per entity type"
      - "Metadata filtering para precisi√≥n"
      - "Batch inserts para performance"

# =============================================================================
# üîå APIs Y INTERFACES
# =============================================================================

api_design:
  # REST API Standards (Airbnb + Microsoft)
  rest:
    base_path: "/api/v{version}"
    current_version: 1
    
    naming:
      resources: "plural nouns (users, orders)"
      actions: "HTTP verbs (GET, POST, PUT, DELETE)"
      example: "GET /api/v1/users/{id}/orders"
    
    status_codes:
      success: "200 OK, 201 Created, 204 No Content"
      client_error: "400, 401, 403, 404, 409, 422"
      server_error: "500 (con detalles en logs, no en respuesta)"
    
    request_response:
      content_type: "application/json"
      charset: "UTF-8"
      date_format: "ISO 8601 (YYYY-MM-DDTHH:MM:SSZ)"
      
    pagination:
      required: true
      strategy: "cursor-based preferred, offset for simple cases"
      max_page_size: 100
      default_page_size: 20
      
    filtering:
      format: "?field__operator=value"
      operators: ["eq", "ne", "gt", "gte", "lt", "lte", "in", "contains"]
      example: "?created_at__gte=2024-01-01&status__in=active,pending"
      
    sorting:
      format: "?sort=field1,-field2"
      default: "-created_at"
      max_sort_fields: 3
  
  # Error Response Format (Google JSON Style)
  error_format:
    structure:
      error:
        code: "integer (HTTP status)"
        message: "string (user-friendly)"
        status: "string (UPPER_SNAKE_CASE)"
        details: 
          - "field: string (which field)"
          - "message: string (specific error)"
        request_id: "string (for tracing)"
        timestamp: "ISO8601"
    example:
      error:
        code: 400
        message: "Invalid input data"
        status: "INVALID_ARGUMENT"
        details:
          - field: "email"
            message: "Must be a valid email address"
        request_id: "req_123456789"
        timestamp: "2025-01-30T14:30:00Z"

# =============================================================================
# üìä M√âTRICAS Y OBSERVABILIDAD
# =============================================================================

observability:
  # M√©tricas requeridas (Google SRE)
  golden_signals:
    required: ["Latency", "Traffic", "Errors", "Saturation"]
    
    latency:
      p50_target_ms: 100
      p95_target_ms: 500
      p99_target_ms: 1000
      
    errors:
      target_rate: "< 0.1%"
      classification: ["5xx server", "4xx client", "timeout", "circuit_breaker"]
      
    saturation:
      cpu_target: "< 70%"
      memory_target: "< 80%"
      disk_target: "< 85%"
  
  # Logging
  logging:
    levels:
      ERROR: "Operaciones fallidas que requieren atenci√≥n"
      WARN: "Condiciones inesperadas pero manejadas"
      INFO: "Operaciones normales"
      DEBUG: "Detalles para debugging"
    
    format: "structured JSON"
    required_fields:
      - "timestamp (ISO8601)"
      - "level"
      - "message"
      - "service"
      - "trace_id"
      - "span_id"
      - "source_location (file:line)"
    
    rules:
      - "Nunca loggear PII (emails, passwords, tokens)"
      - "Nunca loggear en loops sin sampling"
      - "Usar correlation IDs para tracing"
      - "Logs async para no bloquear"
  
  # Tracing
  tracing:
    required: true
    propagation: "W3C Trace Context"
    sampling_rate: "1% en producci√≥n, 100% en desarrollo"
    max_spans_per_trace: 1000

# =============================================================================
# üéØ DECISIONES DE ARQUITECTURA (ADRs)
# =============================================================================

architecture_decisions:
  # Cu√°ndo escribir ADR
  when_to_write:
    - "Cambio significativo de arquitectura"
    - "Nuevo patr√≥n de dise√±o"
    - "Selecci√≥n de tecnolog√≠a"
    - "Cambio en approach de integraci√≥n"
    
  format:
    template: "adr-template.md"
    sections:
      - "Title (short noun phrase)"
      - "Status (proposed, accepted, deprecated, superseded)"
      - "Context (forces at play)"
      - "Decision (response to forces)"
      - "Consequences (positive, negative, neutral)"
      - "Alternatives considered"
      
  location: "docs/architecture/decisions/"
  numbering: "0001-feature-name.md"
  index: "docs/architecture/decisions/README.md"

# =============================================================================
# ‚úÖ VALIDACI√ìN Y CHECKLIST
# =============================================================================

validation:
  # Checklist antes de aprobar dise√±o
  design_review_checklist:
    architecture:
      - "[ ] ¬øSigue los principios fundamentales?"
      - "[ ] ¬øEst√° alineado con los patterns aprobados?"
      - "[ ] ¬øLas dependencias son correctas (apuntan al dominio)?"
      - "[ ] ¬øManeja errores y edge cases?"
      - "[ ] ¬øEs observable (logs, m√©tricas, tracing)?"
      - "[ ] ¬øEs seguro por dise√±o?"
      
    performance:
      - "[ ] ¬øTiene targets de latency definidos?"
      - "[ ] ¬øManeja la carga esperada + 10x?"
      - "[ ] ¬øTiene circuit breakers para dependencias?"
      - "[ ] ¬øEvita N+1 queries?"
      
    scalability:
      - "[ ] ¬øPuede escalar horizontalmente?"
      - "[ ] ¬øEs stateless donde aplica?"
      - "[ ] ¬øSoporta sharding si es necesario?"
      
    maintainability:
      - "[ ] ¬øEs simple de entender? (5 min explanation test)"
      - "[ ] ¬øTiene tests apropiados?"
      - "[ ] ¬øEst√° bien documentado?"
      - "[ ] ¬øSigue los est√°ndares de c√≥digo?"

# =============================================================================
# üö´ ANTI-PATTERNS PROHIBIDOS
# =============================================================================

anti_patterns:
  forbidden:
    - name: "Big Ball of Mud"
      description: "C√≥digo sin estructura clara"
      detection: "M√°s de 10 imports circulares, funciones > 100 l√≠neas"
      
    - name: "God Object/Class"
      description: "Clase que hace demasiado"
      detection: "Clase > 500 l√≠neas, > 20 m√©todos p√∫blicos"
      
    - name: "Spaghetti Code"
      description: "Flujo de control complejo e incomprensible"
      detection: "Cyclomatic complexity > 20, nested depth > 4"
      
    - name: "Golden Hammer"
      description: "Usar la misma soluci√≥n para todo"
      example: "Microservices para todo incluyendo CRUD simples"
      
    - name: "Dependency Hell"
      description: "Demasiadas dependencias circulares"
      detection: "Import cycles, > 10 dependencias por m√≥dulo"
      
    - name: "Magic Numbers/Strings"
      description: "Valores hardcodeados sin contexto"
      solution: "Usar constantes con nombres descriptivos"
      
    - name: "Copy-Paste Programming"
      description: "Duplicaci√≥n de c√≥digo"
      detection: "C√≥digo id√©ntico en 3+ lugares"
      solution: "Refactor a funci√≥n/clase compartida"

# =============================================================================
# üìù NOTAS IMPLEMENTACI√ìN
# =============================================================================

implementation_notes:
  # Para nuevos proyectos
  new_project:
    - "1. Definir bounded contexts y dominios"
    - "2. Crear estructura de directorios base"
    - "3. Implementar dominio primero (TDD)"
    - "4. Agregar infraestructura"
    - "5. Crear interfaces (API/UI)"
    - "6. Documentar ADRs"
    
  # Para refactoring
  refactoring:
    - "1. Escribir tests de caracterizaci√≥n"
    - "2. Identificar seams de refactoring"
    - "3. Extraer dominio gradualmente"
    - "4. Mover infraestructura a adaptadores"
    - "5. Validar con tests en cada paso"
    
  # Tech debt management
  tech_debt:
    tracking: "Labels en issues: tech-debt-{critical,high,medium,low}"
    budget: "20% de cada sprint dedicado a reducir deuda"
    review: "Quarterly architecture review"
