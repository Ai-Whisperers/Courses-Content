# =============================================================================
# üîí SECURITY RULES - REGLAS DE SEGURIDAD
# Basado en: OWASP Top 10, Microsoft SDL, Google Security Best Practices
# Proyecto: FPUNA AI Education - Lead Architect Security Standards
# =============================================================================

meta:
  version: "1.0.0"
  last_updated: "2025-01-30"
  maintainer: "FPUNA AI Education Team"
  scope: ["security", "vulnerability-prevention", "compliance"]
  
  sources:
    - "OWASP Top 10 (2021)"
    - "Microsoft Security Development Lifecycle (SDL)"
    - "Google Security Best Practices"
    - "CIS Controls"
    - "NIST Cybersecurity Framework"
    - "SANS Top 25 Software Errors"

# =============================================================================
# üõ°Ô∏è PRINCIPIOS FUNDAMENTALES DE SEGURIDAD
# =============================================================================

principles:
  # Defense in Depth
  defense_in_depth:
    description: "M√∫ltiples capas de seguridad, no una sola barrera"
    layers:
      - "Network security (firewalls, WAF)"
      - "Application security (input validation)"
      - "Data security (encryption)"
      - "Access control (authentication/authorization)"
      - "Monitoring (logging, alerting)"
    
  # Zero Trust
  zero_trust:
    description: "Nunca confiar, siempre verificar"
    rules:
      - "Verificar identidad en cada solicitud"
      - "Principle of least privilege"
      - "Assume breach mindset"
      - "Verify explicitly, use least privilege access"
    
  # Least Privilege
  least_privilege:
    description: "M√≠nimos permisos necesarios"
    rules:
      - "Grant minimum permissions required"
      - "Regular access reviews"
      - "Temporary elevation when needed"
      - "Deny by default, allow explicitly"
    
  # Fail Secure
  fail_secure:
    description: "En caso de fallo, ser seguro"
    rules:
      - "Default to denial"
      - "Don't expose sensitive info in errors"
      - "Log security events"
      - "Graceful degradation"

# =============================================================================
# üîê AUTENTICACI√ìN Y AUTORIZACI√ìN
# =============================================================================

authentication:
  # Password requirements
  passwords:
    min_length: 12
    max_length: 128
    complexity:
      require_uppercase: true
      require_lowercase: true
      require_numbers: true
      require_special: true
    forbidden:
      - "Common passwords (top 1000)"
      - "Username in password"
      - "Dictionary words"
      - "Sequential characters"
    hashing:
      algorithm: "argon2"
      fallback: "bcrypt"
      never: ["md5", "sha1", "plain text"]
    
  # Multi-factor authentication
  mfa:
    required_for:
      - "Production access"
      - "Administrative functions"
      - "Sensitive data access"
    methods: ["TOTP", "WebAuthn/FIDO2", "Hardware tokens"]
    forbidden: ["SMS (except as backup)"]
    
  # Session management
  sessions:
    timeout_minutes: 30
    absolute_timeout_hours: 8
    regenerate_on_auth: true
    secure_cookies: true
    http_only: true
    same_site: "Strict"
    storage: "server-side only"
    
  # JWT if used
  jwt:
    algorithm: "RS256 or ES256"
    forbidden: ["none", "HS256 with long-lived tokens"]
    expiration: "15 minutes max"
    refresh_tokens:
      rotation: true
      reuse_detection: true
      expiration: "7 days"

authorization:
  # RBAC
  rbac:
    enabled: true
    roles:
      - "admin: Full access"
      - "editor: Read/write"
      - "viewer: Read-only"
      - "service: System-to-system"
    
  # Permission checks
  required_checks:
    - "Verify authentication before authorization"
    - "Check authorization at every entry point"
    - "Deny by default"
    - "Log authorization decisions"
    
  # API authorization
  api:
    use: "OAuth 2.0 + OIDC or API Keys with rotation"
    scopes: "Fine-grained, principle of least privilege"
    validation: "Server-side only, never trust client"

# =============================================================================
# üõ°Ô∏è PROTECCI√ìN DE DATOS
# =============================================================================

data_protection:
  # Encryption in transit
  encryption_in_transit:
    protocol: "TLS 1.3 (minimum 1.2)"
    certificates:
      validity: "Max 1 year"
      automation: "Required (Let's Encrypt, ACME)"
      monitoring: "Expiration alerts at 30, 14, 7 days"
    cipher_suites:
      allowed: ["ECDHE", "AES-GCM", "ChaCha20-Poly1305"]
      forbidden: ["RC4", "DES", "3DES", "MD5", "SHA1"]
    
  # Encryption at rest
  encryption_at_rest:
    databases: "AES-256"
    files: "AES-256"
    backups: "AES-256 + separate key"
    key_management: "KMS (AWS/Azure/GCP) or HashiCorp Vault"
    
  # Sensitive data handling
  sensitive_data:
    classification:
      - "Critical: SSN, credit cards, health records"
      - "Sensitive: Email, phone, address"
      - "Internal: System configs"
      - "Public: Marketing material"
    
    pii_handling:
      minimization: "Collect only necessary data"
      masking: "Mask in logs and UI"
      retention: "Delete when no longer needed"
      consent: "Explicit opt-in for processing"
    
    storage:
      passwords: "Hashed only, never encrypted"
      tokens: "Hashed in DB"
      secrets: "Vault/KMS only"
      
  # Data validation
  validation:
    input:
      - "Validate type, length, format, range"
      - "Sanitize before processing"
      - "Use allowlists, not denylists"
      - "Validate on server-side only"
    
    output:
      - "Encode/escape properly"
      - "Set appropriate Content-Type"
      - "Use CSP headers"

# =============================================================================
# üö´ OWASP TOP 10 PREVENTION
# =============================================================================

owasp_top10:
  # A01: Broken Access Control
  access_control:
    prevention:
      - "Deny by default"
      - "Implement once, reuse everywhere"
      - "Minimize CORS usage"
      - "Rate limiting on APIs"
      - "JWT access tokens short-lived"
    checks:
      - "Automated access control testing"
      - "Manual code review for auth"
      
  # A02: Cryptographic Failures
  crypto_failures:
    prevention:
      - "Encrypt all data in transit"
      - "Encrypt sensitive data at rest"
      - "Proper key management"
      - "Strong password hashing"
    forbidden:
      - "Deprecated crypto (MD5, SHA1, DES)"
      - "Hardcoded keys"
      - "Weak random numbers"
      
  # A03: Injection
  injection:
    prevention:
      - "Parameterized queries ONLY"
      - "ORM escaping"
      - "Input validation"
      - "Least privilege DB access"
    checks:
      - "SAST for injection patterns"
      - "DAST with injection tests"
      
  # A04: Insecure Design
  insecure_design:
    prevention:
      - "Threat modeling"
      - "Secure design patterns"
      - "Business logic security"
      - "Rate limiting"
    
  # A05: Security Misconfiguration
  misconfiguration:
    prevention:
      - "Hardened base images"
      - "Minimal platforms (no unused features)"
      - "Automated hardening"
      - "Regular security patches"
    
  # A06: Vulnerable Components
  vulnerable_components:
    prevention:
      - "Inventory of all components"
      - "Automated dependency scanning"
      - "Patch within 30 days (critical: 7 days)"
      - "Only use maintained libraries"
    
  # A07: Authentication Failures
  auth_failures:
    prevention:
      - "MFA where possible"
      - "Strong password policies"
      - "Secure session management"
      - "Credential breach detection"
    
  # A08: Data Integrity Failures
  integrity_failures:
    prevention:
      - "Verify dependencies with signatures"
      - "CI/CD pipeline security"
      - "Immutable artifacts"
    
  # A09: Security Logging Failures
  logging_failures:
    prevention:
      - "Log all auth events"
      - "Log access control failures"
      - "Tamper-proof logs"
      - "Alert on suspicious patterns"
    
  # A10: SSRF
  ssrf:
    prevention:
      - "Validate URLs"
      - "Deny by default"
      - "Network segmentation"
      - "Use allowlists for remote resources"

# =============================================================================
# üîç SECURE CODING PRACTICES
# =============================================================================

secure_coding:
  # Input validation
  input_validation:
    principle: "Never trust user input"
    rules:
      - "Validate on server-side only"
      - "Use strong typing"
      - "Sanitize all input"
      - "Use parameterized queries"
      - "Validate file uploads (type, size, content)"
    
  # Output encoding
  output_encoding:
    contexts:
      html: "Use HTML entity encoding"
      javascript: "Use JS encoding"
      css: "Use CSS encoding"
      url: "Use URL encoding"
      xml: "Use XML encoding"
      json: "Use proper JSON serialization"
    
  # Authentication code
  auth_code:
    rules:
      - "Never roll your own crypto"
      - "Use established libraries (bcrypt, argon2)"
      - "Constant-time comparison for secrets"
      - "Secure random number generation"
    
  # Session handling
  session_code:
    rules:
      - "Server-side session storage"
      - "Secure, HttpOnly, SameSite cookies"
      - "Regenerate ID on privilege change"
      - "Proper timeout handling"
    
  # File operations
  file_security:
    rules:
      - "Validate file types (magic numbers, not extensions)"
      - "Limit file size"
      - "Store outside web root"
      - "Scan for malware"
      - "No execution permissions"
    
  # Error handling
  error_handling:
    rules:
      - "Don't leak sensitive info in errors"
      - "Generic messages to users"
      - "Detailed logs internally"
      - "No stack traces in production"

# =============================================================================
# üõ†Ô∏è SECURITY TOOLS Y SCANNING
# =============================================================================

security_tools:
  # Static Analysis (SAST)
  sast:
    tools: ["bandit", "semgrep", "CodeQL", "SonarQube"]
    triggers:
      - "pre-commit"
      - "CI/CD pipeline"
      - "Nightly scans"
    severity_threshold: "HIGH"
    
  # Dynamic Analysis (DAST)
  dast:
    tools: ["OWASP ZAP", "Burp Suite"]
    frequency: "Weekly"
    scope: "All endpoints"
    
  # Dependency scanning
  dependency_scanning:
    tools: ["pip-audit", "safety", "Snyk", "Dependabot"]
    frequency: "Daily"
    auto_pr: true
    
  # Secrets scanning
  secrets_scanning:
    tools: ["detect-secrets", "gitleaks", "truffleHog"]
    triggers:
      - "pre-commit"
      - "pre-push"
      - "CI/CD"
    
  # Container scanning
  container_scanning:
    tools: ["Trivy", "Clair", "Anchore"]
    scan: ["OS packages", "Application packages", "Config files"]

# =============================================================================
# üîë SECRETS MANAGEMENT
# =============================================================================

secrets_management:
  # Storage
  storage:
    development: ".env files (gitignored)"
    staging: "Cloud secret manager"
    production: "Cloud secret manager + HSM"
    forbidden: ["Hardcoded", "Git", "Config files"]
    
  # Types of secrets
  secret_types:
    api_keys:
      rotation: "90 days"
      storage: "Secret manager"
    
    database_credentials:
      rotation: "180 days"
      storage: "Secret manager"
      access: "IAM-based when possible"
    
    encryption_keys:
      rotation: "1 year"
      storage: "KMS"
      backup: "Offline, encrypted"
    
    jwt_secrets:
      rotation: "90 days"
      storage: "KMS"
    
  # Best practices
  practices:
    - "Separate secrets per environment"
    - "Automated rotation where possible"
    - "Audit access to secrets"
    - "No shared secrets between services"
    - "Inject at runtime, not build time"

# =============================================================================
# üìù LOGGING Y MONITORING DE SEGURIDAD
# =============================================================================

security_monitoring:
  # Events to log
  events_to_log:
    authentication:
      - "Successful login"
      - "Failed login (with reason)"
      - "Password change"
      - "MFA events"
      - "Session creation/destruction"
    
    authorization:
      - "Access denied"
      - "Permission changes"
      - "Role changes"
    
    data_access:
      - "Sensitive data access"
      - "Bulk data access"
      - "Export operations"
      - "Data modification"
    
    system:
      - "Configuration changes"
      - "Security setting changes"
      - "Admin actions"
    
  # Log format
  log_format:
    required_fields:
      - "timestamp (ISO8601 UTC)"
      - "severity"
      - "event_type"
      - "user_id"
      - "session_id"
      - "ip_address"
      - "user_agent"
      - "resource"
      - "action"
      - "result"
      - "correlation_id"
    
    forbidden_in_logs:
      - "Passwords"
      - "API keys"
      - "PII (mask or hash)"
      - "Credit card numbers"
      - "Session tokens"
      
  # Alerting
  alerting:
    immediate:
      - "Multiple failed logins"
      - "Privilege escalation"
      - "Data exfiltration patterns"
      - "Configuration tampering"
    
    high_priority:
      - "Unusual access patterns"
      - "After-hours admin access"
      - "Failed authorization attempts"
    
    investigation:
      - "New device/login location"
      - "Changes to security settings"

# =============================================================================
# üö® INCIDENT RESPONSE
# =============================================================================

incident_response:
  # Severity levels
  severity:
    critical:
      description: "Active data breach or system compromise"
      response_time: "15 minutes"
      examples:
        - "Active exploitation in production"
        - "Ransomware"
        - "Data exfiltration in progress"
    
    high:
      description: "Potential breach or major vulnerability"
      response_time: "1 hour"
      examples:
        - "Authentication bypass"
        - "SQL injection possible"
        - "Secrets exposed"
    
    medium:
      description: "Security issue requiring attention"
      response_time: "24 hours"
      examples:
        - "Vulnerability in non-critical system"
        - "Policy violation"
    
    low:
      description: "Minor security concern"
      response_time: "1 week"
      examples:
        - "Missing security header"
        - "Info disclosure in error message"
  
  # Response steps
  response_process:
    - "1. Detect - Monitoring and alerts"
    - "2. Triage - Assess severity and scope"
    - "3. Contain - Limit damage"
    - "4. Eradicate - Remove threat"
    - "5. Recover - Restore systems"
    - "6. Learn - Post-incident review"

# =============================================================================
# üìã SECURITY CHECKLISTS
# =============================================================================

security_checklists:
  # Pre-deployment
  pre_deployment:
    - "[ ] SAST scan passed (no HIGH/CRITICAL)"
    - "[ ] Dependency scan passed"
    - "[ ] Secrets scan passed"
    - "[ ] Security tests passing"
    - "[ ] Configuration hardened"
    - "[ ] TLS configured"
    - "[ ] Security headers set"
    - "[ ] Logging configured"
    - "[ ] Rate limiting enabled"
    - "[ ] WAF rules active"
    
  # Code review
  code_review_security:
    - "[ ] Input validation present"
    - "[ ] Output encoding correct"
    - "[ ] Authentication checks present"
    - "[ ] Authorization checks present"
    - "[ ] No hardcoded secrets"
    - "[ ] No SQL injection risks"
    - "[ ] No XSS vulnerabilities"
    - "[ ] Error handling secure"
    - "[ ] Logging appropriate"
    - "[ ] Crypto usage correct"
