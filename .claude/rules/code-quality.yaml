# =============================================================================
# ðŸ’» CODE QUALITY RULES - REGLAS DE CALIDAD DE CÃ“DIGO
# Basado en: Google Python Style, PEP8, Black, isort, Ruff
# Proyecto: FPUNA AI Education - Lead Architect Standards
# =============================================================================

meta:
  version: "1.0.0"
  last_updated: "2025-01-30"
  maintainer: "FPUNA AI Education Team"
  scope: ["code-style", "quality-gates", "review-standards"]
  
  sources:
    - "Google Python Style Guide"
    - "PEP 8 - Style Guide for Python Code"
    - "Black Code Style"
    - "isort Documentation"
    - "Ruff Linter Rules"
    - "Airbnb JavaScript Style Guide (adapted)"

# =============================================================================
# ðŸŽ¨ FORMATO Y ESTILO
# =============================================================================

formatting:
  # Black - The uncompromising code formatter
  black:
    enabled: true
    line_length: 120
    target_versions: ["py311"]
    skip_string_normalization: false
    include: "\\.pyi?$"
    exclude: "(\\.git|\\.hg|\\.mypy_cache|\\.tox|\\.venv|venv|_build|buck-out|build|dist|migrations|__pycache__)"

  # isort - Import sorting
  isort:
    enabled: true
    profile: "black"
    line_length: 120
    multi_line_output: 3
    include_trailing_comma: true
    force_grid_wrap: 0
    use_parentheses: true
    ensure_newline_before_comments: true
    sections:
      - "FUTURE"
      - "STDLIB"
      - "THIRDPARTY"
      - "FIRSTPARTY"
      - "LOCALFOLDER"
    known_first_party: ["fpuna", "src"]
    known_third_party: ["pydantic", "fastapi", "sqlalchemy"]

# =============================================================================
# ðŸ” LINTING Y ANÃLISIS ESTÃTICO
# =============================================================================

linting:
  # Ruff - Ultra-fast Python linter (Rust-based)
  ruff:
    enabled: true
    line_length: 120
    target_version: "py311"
    select:
      - "E"  # pycodestyle errors
      - "F"  # Pyflakes
      - "I"  # isort
      - "N"  # pep8-naming
      - "W"  # pycodestyle warnings
      - "UP" # pyupgrade
      - "B"  # flake8-bugbear
      - "C4" # flake8-comprehensions
      - "SIM" # flake8-simplify
      - "ARG" # flake8-unused-arguments
    ignore:
      - "E203"  # Whitespace before ':' (conflict with black)
      - "E501"  # Line too long (handled by black)
      - "W503"  # Line break before binary operator (outdated)
    fixable:
      - "ALL"
    unfixable: []
    exclude:
      - ".git"
      - "__pycache__"
      - "build"
      - "dist"
      - "migrations"
      - ".venv"
      - "venv"
      - ".tox"
    per_file_ignores:
      "__init__.py": ["F401"]  # Unused imports ok in __init__.py
      "tests/**/*.py": ["S101"]  # Assert ok in tests
      "**/*_test.py": ["S101"]
      "**/test_*.py": ["S101"]

  # Flake8 - Traditional Python linter
  flake8:
    enabled: true
    max_line_length: 120
    extend_ignore:
      - "E203"  # whitespace before ':'
      - "E501"  # line too long
      - "W503"  # line break before binary operator
      - "F403"  # star imports
      - "F405"  # undefined names from star import
      - "F821"  # undefined names (handled by mypy)
      - "E722"  # bare except (handled by bandit)
    max_complexity: 12
    max_doc_length: 120
    statistics: true
    count: true
    show_source: true
    builtins: ["_"]
    exclude:
      - ".git"
      - "__pycache__"
      - ".tox"
      - ".eggs"
      - "*.egg"
      - "build"
      - "dist"
      - "venv"
      - ".venv"
      - "migrations"
    plugins:
      - flake8-bugbear
      - flake8-comprehensions
      - flake8-docstrings
      - flake8-import-order
      - flake8-simplify

  # Pylint - Comprehensive static analysis
  pylint:
    enabled: false  # Disabled in favor of ruff + flake8 (faster)
    # Keep for reference or specific checks
    max_line_length: 120
    disable:
      - "C0103"  # Invalid name (handled by naming conventions)
      - "C0301"  # Line too long
      - "R0903"  # Too few public methods
      - "R0913"  # Too many arguments
      - "W0511"  # TODO/FIXME (managed separately)

# =============================================================================
# ðŸ·ï¸ TYPE CHECKING
# =============================================================================

typing:
  # mypy - Static type checker
  mypy:
    enabled: true
    python_version: "3.11"
    platform: "linux"
    
    # Strictness
    strict: true
    warn_return_any: true
    warn_unused_configs: true
    warn_redundant_casts: true
    warn_unused_ignores: true
    warn_unreachable: true
    
    # Disallow options
    disallow_untyped_defs: true
    disallow_incomplete_defs: true
    disallow_untyped_calls: true
    disallow_untyped_decorators: true
    disallow_subclassing_any: false  # Can be too strict for legacy
    disallow_any_generics: false
    
    # Error output
    show_error_codes: true
    show_column_numbers: true
    show_error_context: true
    pretty: true
    color_output: true
    error_summary: true
    
    # Import handling
    ignore_missing_imports: true
    follow_imports: "normal"
    follow_imports_for_stubs: true
    
    # Incremental
    incremental: true
    cache_dir: ".mypy_cache"
    
    # Exclusions
    exclude:
      - ".git"
      - "__pycache__"
      - ".tox"
      - ".venv"
      - "venv"
      - "build"
      - "dist"
      - "tests"
      - "migrations"
      - "docs"
    
    per_module_options:
      "tests.*":
        disallow_untyped_defs: false
      "migrations.*":
        ignore_errors: true

# =============================================================================
# ðŸ“ NAMING CONVENTIONS
# =============================================================================

naming:
  # Variables
  variables:
    style: "snake_case"
    examples: ["user_count", "total_price", "is_valid"]
    constants: "UPPER_SNAKE_CASE"
    private: "_leading_underscore"
    
  # Functions
  functions:
    style: "snake_case"
    examples: ["calculate_total", "get_user_by_id", "is_authenticated"]
    private: "_leading_underscore"
    
  # Classes
  classes:
    style: "PascalCase"
    examples: ["UserService", "PaymentGateway", "HttpClient"]
    exceptions: "PascalCase + Error/Exception suffix"
    examples_exceptions: ["NotFoundError", "ValidationException"]
    
  # Modules
  modules:
    style: "snake_case"
    examples: ["user_service.py", "payment_gateway.py"]
    short: "Prefer short, lowercase names"
    
  # Packages
  packages:
    style: "snake_case"
    examples: ["user_management", "payment_processing"]
    no_underscores: "Avoid when possible"
    
  # Type Variables
  typevars:
    style: "PascalCase + _co or _contra suffix"
    examples: ["T", "KT", "VT_co"]
    
  # Type Aliases
  type_aliases:
    style: "PascalCase"
    examples: ["UserId", "JsonDict", "HandlerFunc"]

# =============================================================================
# ðŸ§¹ CODE QUALITY METRICS
# =============================================================================

metrics:
  # Complexity (measured by radon)
  complexity:
    tool: "radon"
    ranks:
      A: {max: 5, description: "Simple - low risk"}
      B: {max: 10, description: "Moderate - low risk"}
      C: {max: 20, description: "Complex - moderate risk"}
      D: {max: 30, description: "Very complex - high risk"}
      E: {max: 40, description: "Unmaintainable - very high risk"}
      F: {min: 41, description: "Refactor immediately"}
    
    thresholds:
      max_per_function: 10  # Flag if > 10
      max_per_module: 50    # Flag if sum > 50
      target_average: 5     # Aim for average <= 5
  
  # Maintainability Index
  maintainability:
    tool: "radon"
    ranks:
      A: {min: 100, description: "Excellent"}
      B: {min: 85, description: "Good"}
      C: {min: 70, description: "Moderate"}
      D: {min: 50, description: "Poor"}
      F: {max: 49, description: "Unmaintainable"}
    
    threshold: 70  # Minimum acceptable
  
  # Raw Metrics
  raw:
    loc: {max_per_file: 500, description: "Lines of code"}
    sloc: {max_per_file: 400, description: "Source lines"}
    comments: {min_percent: 10, description: "Comment percentage"}
    blank: {max_percent: 20, description: "Blank line percentage"}
    
  # Function/Class size
  size:
    max_function_lines: 50
    max_class_lines: 300
    max_module_lines: 1000
    max_parameters: 5
    max_returns: 3
    max_local_variables: 15
    max_branches: 12
    max_nesting_depth: 4

# =============================================================================
# ðŸŽ¯ CODE REVIEW STANDARDS
# =============================================================================

code_review:
  # Google: Small changes, fast review
  change_size:
    max_lines_per_pr: 400
    max_files_per_pr: 15
    max_commits_per_pr: 10
    ideal_lines_per_pr: 200
    
  # Review time expectations
  response_time:
    urgent: "2 hours"
    normal: "24 hours"
    non_urgent: "48 hours"
    
  # Review thoroughness
  check_for:
    design: "Is the design well-thought-out and appropriate?"
    functionality: "Does the code behave as expected?"
    complexity: "Is the code more complex than necessary?"
    tests: "Are there appropriate tests with good coverage?"
    naming: "Did the developer choose clear names?"
    comments: "Are comments clear and useful?"
    style: "Does the code follow style guidelines?"
    documentation: "Is there appropriate documentation?"
    
  # Review feedback
  feedback_style:
    questions: "Ask questions rather than make demands"
    explain_why: "Always explain the reasoning"
    compliments: "Give positive feedback on good code"
    actionable: "Make suggestions specific and actionable"
    
  # Approval criteria
  approval_requirements:
    - "All comments addressed or responded to"
    - "CI checks passing"
    - "No new linting errors"
    - "Test coverage maintained or improved"
    - "Documentation updated if needed"
    - "At least one approval from code owner"

# =============================================================================
# ðŸ› ERROR HANDLING
# =============================================================================

error_handling:
  # Philosophy
  philosophy: "Fail fast, fail loud, handle gracefully"
  
  # Rules
  rules:
    - "NEVER silently swallow errors"
    - "ALWAYS log errors with context"
    - "Use specific exceptions, not generic Exception"
    - "Catch exceptions at appropriate levels"
    - "Preserve stack traces when re-raising"
    - "Provide actionable error messages"
    - "Use structured errors for APIs"
    
  # Forbidden patterns
  forbidden:
    - pattern: "except: pass"
      reason: "Silently swallows all errors"
    - pattern: "except Exception: pass"
      reason: "Still too broad"
    - pattern: "try: ... except: return None"
      reason: "Hides errors from caller"
    - pattern: "bare except clause"
      reason: "Catches KeyboardInterrupt, SystemExit"
      
  # Required patterns
  required:
    - pattern: "except SpecificError as e:"
      example: "except ValueError as e:"
    - pattern: "log + re-raise for critical"
      example: |
        try:
            critical_operation()
        except CriticalError as e:
            logger.error(f"Critical operation failed: {e}")
            raise
    - pattern: "log + return Result for non-critical"
      example: |
        try:
            optional_operation()
        except OptionalError as e:
            logger.warning(f"Optional operation failed: {e}")
            return Result.failure(e)

# =============================================================================
# ðŸ“š DOCUMENTATION EN CÃ“DIGO
# =============================================================================

documentation:
  # Docstrings (Google Style)
  docstrings:
    style: "google"
    required_for:
      - "All public modules"
      - "All public classes"
      - "All public functions/methods"
    
    format:
      one_liner: |
        """Short description in imperative mood."""
      multi_line: |
        """Short description.
        
        Longer description if needed. Can span multiple lines.
        
        Args:
            arg1: Description of arg1
            arg2: Description of arg2
            
        Returns:
            Description of return value
            
        Raises:
            ErrorType: When this error occurs
            
        Examples:
            >>> function_name(1, 2)
            3
        """
    
    sections:
      required:
        - "Args (for functions with parameters)"
        - "Returns (for non-None returns)"
        - "Raises (for documented exceptions)"
      optional:
        - "Examples (for complex functions)"
        - "Note (for important notes)"
        - "References (for external resources)"
        
  # Comments
  comments:
    when_to_use:
      - "Explain WHY, not WHAT"
      - "Document workarounds and hacks"
      - "Reference issue trackers (TODO: #123)"
      - "Explain complex algorithms"
    
    forbidden:
      - "Obvious comments (x = x + 1  # Increment x)"
      - "Outdated comments"
      - "Commented-out code"
      
    todo_format: "TODO(author): description #issue-number"
    example: "TODO(john): Refactor this once service is ready #456"

# =============================================================================
# ðŸ§ª TESTING EN CÃ“DIGO
# =============================================================================

testing_in_code:
  # Testability requirements
  requirements:
    - "Design for testability from the start"
    - "Use dependency injection"
    - "Avoid global state"
    - "Prefer pure functions"
    - "Keep side effects isolated"
    
  # Test indicators in code
  indicators:
    test_methods: "Functions should be testable in isolation"
    test_classes: "Classes should be mockable"
    test_modules: "Modules should have clear interfaces"
    
  # Avoid in production code
  avoid:
    - "Hardcoded test data"
    - "Test logic mixed with production"
    - "Debug print statements"
    - "Conditional logic for test mode"

# =============================================================================
# ðŸ”§ REFACTORING GUIDELINES
# =============================================================================

refactoring:
  # When to refactor
  triggers:
    - "Duplicated code (Rule of Three)"
    - "Function > 50 lines"
    - "Complexity rank C or higher"
    - "Class with > 10 public methods"
    - "Feature envy (using other class's data)"
    - "Shotgun surgery (change affects many places)"
    
  # Safe refactoring steps
  process:
    - "1. Ensure tests exist and pass"
    - "2. Identify refactoring pattern"
    - "3. Make small, incremental changes"
    - "4. Run tests after each change"
    - "5. Commit working state frequently"
    - "6. Review and document"
    
  # Patterns catalog
  patterns:
    - "Extract Method"
    - "Extract Class"
    - "Move Method"
    - "Rename (everything)"
    - "Replace Conditional with Polymorphism"
    - "Introduce Parameter Object"
    - "Replace Magic Numbers with Constants"

# =============================================================================
# âš¡ MODERN PYTHON FEATURES
# =============================================================================

modern_python:
  version: "3.11+"
  
  features_to_use:
    - "Type hints (everywhere)"
    - "f-strings (all string formatting)"
    - "pathlib (instead of os.path)"
    - "dataclasses (for simple data containers)"
    - "enums (for choices/constants)"
    - "walrus operator := (when appropriate)"
    - "match/case (for pattern matching)"
    - "async/await (for I/O bound)"
    - "generators (for large datasets)"
    
  features_to_avoid:
    - "% formatting (deprecated)"
    - ".format() (f-strings preferred)"
    - "os.path (pathlib preferred)"
    - "map/filter (comprehensions preferred)"
    - "lambda assignments (use def)"
    - "star imports (explicit imports)"
    
  typing_features:
    - "Generic types (list[str] vs List[str])"
    - "Union with | (str | int vs Union[str, int])"
    - "Optional with | (str | None vs Optional[str])"
    - "TypeVar and Generic classes"
    - "Protocol for structural typing"
    - "TypedDict for dictionary types"

# =============================================================================
# ðŸŽ“ EDUCATION-SPECIFIC (FPUNA Context)
# =============================================================================

education_context:
  # For student code
  student_code:
    relaxations:
      - "Complexity limit: 20 (vs 10 for production)"
      - "Type hints: 80% coverage acceptable"
      - "Docstrings: Required only for public APIs"
    
    strict_requirements:
      - "No security vulnerabilities"
      - "No bare except clauses"
      - "No hardcoded credentials"
      - "Tests for core functionality"
      
  # For teaching materials
  teaching_materials:
    requirements:
      - "Comments explaining WHY not WHAT"
      - "Progressive complexity (start simple)"
      - "Complete working examples"
      - "Error handling demonstrations"
      - "Performance comparisons where relevant"
