---
description: Testing conventions and patterns
globs: "**/*.test.ts,**/*.spec.ts,**/tests/**"
---

# Testing Standards

## Test Structure

### Organization
- Group related tests with `describe` blocks
- Use nested describes for method grouping
- One concept per test
- Keep tests focused and readable

### Naming
- Use descriptive test names
- Pattern: `should_doExpectedBehavior_when_condition`
- Example: `should_throwError_when_emailIsInvalid`

### Setup/Teardown
- Reset state in `beforeEach`
- Clean up in `afterEach`
- Use `beforeAll`/`afterAll` sparingly (only for expensive setup)

## AAA Pattern

```typescript
it('should create user with valid data', async () => {
  // Arrange - Set up test data and mocks
  const userData = { name: 'Test', email: 'test@example.com' };
  mockDb.users.create.mockResolvedValue({ id: 1, ...userData });

  // Act - Execute the code under test
  const result = await userService.createUser(userData);

  // Assert - Verify the results
  expect(result).toMatchObject({
    id: expect.any(Number),
    name: 'Test',
    email: 'test@example.com'
  });
  expect(mockDb.users.create).toHaveBeenCalledWith(userData);
});
```

## Mocking

### Module Mocking
```typescript
jest.mock('../services/emailService');
const mockEmailService = emailService as jest.Mocked<typeof emailService>;
```

### Method Mocking
```typescript
const spy = jest.spyOn(userService, 'validate');
spy.mockReturnValue(true);
```

### Reset Mocks
```typescript
afterEach(() => {
  jest.clearAllMocks();
});
```

## Assertions

### Specific Matchers
- Use `toBe` for primitives
- Use `toEqual` for objects/arrays
- Use `toMatchObject` for partial matches
- Use `toThrow` for errors (with message check)

### Examples
```typescript
// Primitives
expect(result).toBe(true);
expect(count).toBe(5);

// Objects
expect(user).toEqual({ id: 1, name: 'Test' });
expect(user).toMatchObject({ name: 'Test' });

// Arrays
expect(items).toHaveLength(3);
expect(items).toContainEqual({ id: 1 });

// Errors
expect(() => validate(null)).toThrow('Input required');
expect(async () => await fetch()).rejects.toThrow();

// Calls
expect(mockFn).toHaveBeenCalled();
expect(mockFn).toHaveBeenCalledWith('arg');
expect(mockFn).toHaveBeenCalledTimes(1);
```

## Test Categories

### Unit Tests
- Test single functions/methods in isolation
- Mock all dependencies
- Fast execution (< 100ms each)
- High coverage of edge cases

### Integration Tests
- Test multiple components together
- Use real database (test instance)
- Test API endpoints end-to-end
- Verify data persistence

### E2E Tests
- Test complete user flows
- Use Playwright for browser automation
- Follow Page Object Model
- Include visual regression tests

## Coverage Requirements
- Minimum: 80% line coverage
- Target: 90%+ for critical paths
- Branch coverage: Test all conditionals
- Focus on business logic, not boilerplate
